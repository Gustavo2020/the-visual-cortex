# Production-ready Docker Compose with Nginx reverse proxy and SSL
# Usage:
#   docker-compose -f docker-compose.production.yml up -d
#
# Prerequisites:
#   1. Copy .env.example to .env and update DOMAIN
#   2. Generate SSL certificates:
#      sudo certbot certonly --standalone -d yourdomain.com
#   3. Place cert files in ./certs/ or update paths below

version: '3.8'

services:
  # FastAPI backend (CLIP Search API)
  api:
    build:
      context: .
      dockerfile: src/Dockerfile
    container_name: visual-cortex-api
    restart: unless-stopped
    environment:
      CLIP_MODEL: "${CLIP_MODEL:-ViT-B-32}"
      CLIP_PRETRAINED: "${CLIP_PRETRAINED:-openai}"
      CLIP_DEVICE: "${CLIP_DEVICE:-cpu}"
      EMBEDDINGS_DIR: "/app/data/embeddings"
      LOG_LEVEL: "${LOG_LEVEL:-INFO}"
    volumes:
      - ./data:/app/data
    expose:
      - 8000
    ports:
      - "127.0.0.1:8000:8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - webnet
    # Resource limits (adjust for your server)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

  # Streamlit UI
  ui:
    build:
      context: .
      dockerfile: ui/Dockerfile
    container_name: visual-cortex-ui
    restart: unless-stopped
    environment:
      API_HOST: "api"
      API_PORT: "8000"
      STREAMLIT_SERVER_PORT: "8501"
      STREAMLIT_BASE_URL_PATH: "the-visual-cortex"
    expose:
      - 8501
    ports:
      - "127.0.0.1:8501:8501"
    depends_on:
      api:
        condition: service_healthy
    networks:
      - webnet
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Nginx reverse proxy with SSL
  nginx:
    image: nginx:latest
    container_name: visual-cortex-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./src/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/nginx/certs:ro
      - ./html:/usr/share/nginx/html:ro
    depends_on:
      - api
      - ui
    networks:
      - webnet
    environment:
      DOMAIN: "${DOMAIN:-localhost}"

networks:
  webnet:
    driver: bridge

volumes:
  embeddings:
    driver: local
